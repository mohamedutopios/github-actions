# ============================================================
# DÃ‰MO 3/4 â€” Variables : sortie dynamique entre steps et jobs
# ============================================================
# Un step peut PRODUIRE une valeur qu'un step suivant
# peut LIRE. MÃ©canisme : GITHUB_OUTPUT
#
# Ã‰crire une valeur (dans step A) :
#   echo "ma_cle=ma_valeur" >> $GITHUB_OUTPUT
#
# Lire la valeur (dans step B, mÃªme job) :
#   ${{ steps.id_step_a.outputs.ma_cle }}
#
# Lire la valeur (dans un autre job) :
#   ${{ needs.id_job.outputs.ma_cle }}
#   âš ï¸ NÃ©cessite de dÃ©clarer "outputs:" sur le job source
#   âš ï¸ NÃ©cessite "needs: id_job" sur le job destinataire
# ============================================================

name: "19 Â· Sorties dynamiques entre steps et jobs"

on: workflow_dispatch

jobs:
  # â”€â”€â”€ Job 1 â€” Produit les valeurs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  demo-outputs:
    name: "Passer des valeurs entre steps"
    runs-on: ubuntu-latest

    # DÃ©clare les sorties du job pour les exposer aux autres jobs
    outputs:
      version:    ${{ steps.calcul-version.outputs.version }}
      date_build: ${{ steps.calcul-version.outputs.date_build }}

    steps:
      # Step A â€” Produit deux valeurs de sortie
      - name: "ğŸ·ï¸ Step A â€” Calculer la version"
        id: calcul-version           # â† l'id permet de rÃ©fÃ©rencer ce step
        run: |
          DATE=$(date +%Y%m%d)
          VERSION="1.0.${{ github.run_number }}"
          echo "ğŸ“Œ Version calculÃ©e : $VERSION"
          echo "ğŸ“Œ Date du build    : $DATE"

          # Ã‰crire les sorties dans GITHUB_OUTPUT
          echo "version=$VERSION"     >> $GITHUB_OUTPUT
          echo "date_build=$DATE"     >> $GITHUB_OUTPUT

      # Step B â€” Lit les valeurs produites par step A
      - name: "ğŸ“– Step B â€” Utiliser la version calculÃ©e"
        run: |
          echo "=== Valeurs reÃ§ues depuis Step A ==="
          echo "Version    : ${{ steps.calcul-version.outputs.version }}"
          echo "Date build : ${{ steps.calcul-version.outputs.date_build }}"

      # Step C â€” Utilise aussi les valeurs
      - name: "ğŸ·ï¸ Step C â€” CrÃ©er un tag avec la version"
        run: |
          VERSION="${{ steps.calcul-version.outputs.version }}"
          echo "Tag qui serait crÃ©Ã© : v$VERSION"
          echo "Image Docker : mon-app:$VERSION"

  # â”€â”€â”€ Job 2 â€” Lit les valeurs du Job 1 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  demo-outputs-between-jobs:
    name: "Passer des valeurs entre jobs"
    runs-on: ubuntu-latest
    needs: demo-outputs   # â† attend que le job "demo-outputs" soit terminÃ©

    steps:
      - name: "ğŸ“– Lire les sorties du job prÃ©cÃ©dent"
        run: |
          echo "=== Valeurs reÃ§ues depuis Job 1 ==="
          echo "Version    : ${{ needs.demo-outputs.outputs.version }}"
          echo "Date build : ${{ needs.demo-outputs.outputs.date_build }}"

      - name: "ğŸ·ï¸ Utiliser la version pour un tag Docker"
        run: |
          VERSION="${{ needs.demo-outputs.outputs.version }}"
          echo "Tag qui serait crÃ©Ã© : v$VERSION"
          echo "Image Docker : mon-app:$VERSION"