# ============================================================
# DÃ‰MO 2/4 â€” Actions : setup-node + cache npm
# ============================================================
# "actions/setup-node" installe et configure Node.js.
# L'option "cache: 'npm'" met node_modules en cache
# pour accÃ©lÃ©rer les prochains runs (Ã©vite de tout
# retÃ©lÃ©charger Ã  chaque fois).
#
# Avec "with:", on passe des paramÃ¨tres Ã  l'action,
# comme des arguments de fonction.
# ============================================================

# ============================================================
# DÃ‰MO 2/4 â€” setup-node + cache npm (version corrigÃ©e)
# ============================================================

name: "14 Â· Action setup-node + cache"

on: workflow_dispatch

jobs:
  demo-node:
    name: "setup-node avec cache npm"
    runs-on: ubuntu-latest

    steps:
      - name: "ğŸ“¥ Checkout"
        uses: actions/checkout@v4

      # ğŸ” VÃ©rifier si un lock file existe
      - name: "ğŸ” DÃ©tection lock file"
        id: lockfile
        run: |
          if [ -f package-lock.json ]; then
            echo "found=true" >> $GITHUB_OUTPUT
          else
            echo "found=false" >> $GITHUB_OUTPUT
          fi

      # âš™ï¸ Setup Node avec cache seulement si lock file prÃ©sent
      - name: "âš™ï¸ Configurer Node.js 20 avec cache npm"
        if: steps.lockfile.outputs.found == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      # âš™ï¸ Setup Node sans cache sinon
      - name: "âš™ï¸ Configurer Node.js 20 (sans cache)"
        if: steps.lockfile.outputs.found == 'false'
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: "ğŸ” VÃ©rifier la version installÃ©e"
        run: |
          echo "Node  : $(node --version)"
          echo "npm   : $(npm --version)"
          echo "npx   : $(npx --version)"

      - name: "ğŸ“¦ Installer les dÃ©pendances (si package.json existe)"
        run: |
          if [ -f package.json ]; then
            npm ci
            echo "âœ… DÃ©pendances installÃ©es"
          else
            echo "â„¹ï¸ Pas de package.json dans ce dÃ©pÃ´t"
          fi
