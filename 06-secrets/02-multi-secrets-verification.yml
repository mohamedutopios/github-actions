# ============================================================
# D√âMO 2/3 ‚Äî Secrets : plusieurs secrets + v√©rification
# ============================================================
# Cas r√©el : un d√©ploiement n√©cessite plusieurs secrets
# (identifiant + mot de passe + URL du serveur).
#
# Secrets √† cr√©er dans Settings ‚Üí Secrets and variables :
#   DEPLOY_HOST     ‚Üí adresse du serveur (ex: 192.168.1.1)
#   DEPLOY_USER     ‚Üí utilisateur SSH (ex: ubuntu)
#   DEPLOY_SSH_KEY  ‚Üí cl√© priv√©e SSH (contenu du fichier)
#
# Ce workflow montre comment les utiliser et comment
# v√©rifier qu'ils ont bien √©t√© configur√©s.
# ============================================================

name: "22 ¬∑ Secrets ‚Äî plusieurs secrets + v√©rification"

on: workflow_dispatch

jobs:
  demo-multi-secrets:
    name: "V√©rifier la pr√©sence des secrets"
    runs-on: ubuntu-latest

    steps:
      - name: "üîç V√©rifier que les secrets sont bien configur√©s"
        env:
          DEPLOY_HOST:    ${{ secrets.DEPLOY_HOST }}
          DEPLOY_USER:    ${{ secrets.DEPLOY_USER }}
          DEPLOY_SSH_KEY: ${{ secrets.DEPLOY_SSH_KEY }}
        run: |
          echo "=== V√©rification des secrets ==="

          # Un secret non configur√© a une longueur de 0
          check_secret() {
            local name="$1"
            local value="$2"
            if [ -z "$value" ]; then
              echo "‚ùå $name : NON CONFIGUR√â"
            else
              echo "‚úÖ $name : configur√© (${#value} caract√®res)"
            fi
          }

          check_secret "DEPLOY_HOST"    "$DEPLOY_HOST"
          check_secret "DEPLOY_USER"    "$DEPLOY_USER"
          check_secret "DEPLOY_SSH_KEY" "$DEPLOY_SSH_KEY"

      - name: "üöÄ Simuler un d√©ploiement SSH"
        env:
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
        run: |
          if [ -z "$DEPLOY_HOST" ] || [ -z "$DEPLOY_USER" ]; then
            echo "‚ö†Ô∏è  Secrets manquants ‚Äî d√©ploiement simul√© seulement"
            echo "    Connexion SSH : $DEPLOY_USER@$DEPLOY_HOST"
          else
            echo "üöÄ Connexion √† $DEPLOY_USER@$DEPLOY_HOST..."
            echo "   (connexion SSH simul√©e pour la d√©mo)"
          fi
