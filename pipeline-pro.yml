# =============================================================
# TP CORRIGÃ‰ â€” Actions, Variables & Secrets Â· utopios-app
# Concepts : actions Marketplace Â· variables env Â· secrets
# =============================================================

name: "Pipeline Pro Â· utopios-app"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Ã‰TAPE 1 â€” DÃ©clencheurs (repris du TP prÃ©cÃ©dent)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
on:
  push:
  workflow_dispatch:

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Ã‰TAPE 2 â€” Variables au niveau WORKFLOW
# Disponibles dans tous les jobs et tous les steps.
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
env:
  APP_NAME: "utopios-app"
  NODE_ENV: "test"

jobs:
  ci:
    name: "ğŸ”„ CI â€” Build, Test & Notify"
    runs-on: ubuntu-latest

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # Ã‰TAPE 2 â€” Variables au niveau JOB
    # Disponibles dans tous les steps de ce job uniquement.
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    env:
      CI: "true"
      RAPPORT_DIR: "test-results"

    steps:

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Ã‰TAPE 1 â€” Action : checkout
      # Clone le dÃ©pÃ´t sur la machine du runner.
      # Sans ce step, index.js n'existe pas sur le runner.
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: "ğŸ“¥ Cloner le dÃ©pÃ´t"
        uses: actions/checkout@v4

      - name: "ğŸ” VÃ©rifier le contenu clonÃ©"
        run: ls -la

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Ã‰TAPE 1 â€” Action : setup-node
      # Installe Node.js 20 et active le cache npm.
      # Le cache Ã©vite de retÃ©lÃ©charger node_modules Ã  chaque run.
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: "âš™ï¸ Configurer Node.js 20"
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: "ğŸ” VÃ©rifier les versions"
        run: |
          echo "Node : $(node --version)"
          echo "npm  : $(npm --version)"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Ã‰TAPE 1 â€” Installer les dÃ©pendances
      # Commande shell classique (run:), pas une action.
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: "ğŸ“¦ Installer les dÃ©pendances"
        run: npm install

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Ã‰TAPE 2 â€” Afficher les variables et calculer la version
      # Combine variables globales, variables de job,
      # et contextes GitHub. Produit un output "version"
      # rÃ©utilisable dans les steps suivants.
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: "ğŸ“‹ Afficher les variables"
        id: infos                      # â† id nÃ©cessaire pour lire l'output
        run: |
          echo "=== Variables du workflow ==="
          echo "APP_NAME  : $APP_NAME"
          echo "NODE_ENV  : $NODE_ENV"
          echo ""
          echo "=== Variables du job ==="
          echo "CI        : $CI"
          echo "RAPPORT_DIR: $RAPPORT_DIR"
          echo ""
          VERSION="1.0.${{ github.run_number }}"
          echo "Version calculÃ©e : $VERSION"

          # Ã‰crire la version dans GITHUB_OUTPUT
          # â†’ sera lisible par les steps suivants via steps.infos.outputs.version
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Ã‰TAPE 1 â€” Lancer les tests
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: "ğŸ§ª Lancer les tests"
        run: node index.test.js

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Ã‰TAPES 1 & 2 â€” CrÃ©er le rapport et uploader l'artifact
      # Le rapport inclut la version calculÃ©e dans le step prÃ©cÃ©dent,
      # lue via steps.infos.outputs.version.
      # L'action upload-artifact sauvegarde le dossier
      # et le rend tÃ©lÃ©chargeable depuis l'onglet Actions.
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: "ğŸ“„ CrÃ©er le rapport"
        run: |
          mkdir -p $RAPPORT_DIR
          echo "Application  : $APP_NAME"                              > $RAPPORT_DIR/rapport.txt
          echo "Version      : ${{ steps.infos.outputs.version }}"   >> $RAPPORT_DIR/rapport.txt
          echo "Environnement: $NODE_ENV"                             >> $RAPPORT_DIR/rapport.txt
          echo "ExÃ©cutÃ© le   : $(date)"                               >> $RAPPORT_DIR/rapport.txt
          cat $RAPPORT_DIR/rapport.txt

      - name: "â¬†ï¸ Sauvegarder le rapport (artifact)"
        uses: actions/upload-artifact@v4
        with:
          name: rapport-tests
          path: ${{ env.RAPPORT_DIR }}/
          retention-days: 7

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Ã‰TAPE 3 â€” VÃ©rifier les secrets
      # Les secrets sont injectÃ©s via env: au niveau du step.
      # Bonne pratique : ne jamais Ã©crire ${{ secrets.X }}
      # directement dans run: â€” toujours passer par env:.
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: "ğŸ” VÃ©rifier les secrets"
        env:
          DEPLOY_TOKEN:    ${{ secrets.DEPLOY_TOKEN }}
          NOTIFY_WEBHOOK:  ${{ secrets.NOTIFY_WEBHOOK }}
        run: |
          echo "=== VÃ©rification des secrets ==="

          if [ -z "$DEPLOY_TOKEN" ] || [ -z "$NOTIFY_WEBHOOK" ]; then
            echo "âŒ Secrets manquants â€” vÃ©rifiez la configuration"
          else
            echo "âœ… Secrets correctement configurÃ©s"
            echo "Token    : ${#DEPLOY_TOKEN} caractÃ¨res"
            echo "Webhook  : ${NOTIFY_WEBHOOK:0:5}***"
          fi

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Ã‰TAPE 3 â€” Simuler une notification
      # On utilise uniquement les caractÃ¨res non-sensibles
      # du webhook pour identifier la destination dans les logs.
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: "ğŸ”” Simuler une notification"
        env:
          NOTIFY_WEBHOOK: ${{ secrets.NOTIFY_WEBHOOK }}
        run: |
          echo "Notification envoyÃ©e vers ${NOTIFY_WEBHOOK:0:8}***"
